<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yoel Professional Barber</title>
    
    <!-- PWA & Metadatos -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Yoel Barber">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/483/483933.png">
    
    <meta name="description" content="Agenda tu cita con los mejores profesionales.">
    <meta property="og:title" content="Yoel Professional Barber">
    <meta property="og:image" content="https://images.unsplash.com/photo-1585747860715-2ba37e788b70?q=80&w=1200&auto=format&fit=crop">
    <meta property="og:type" content="website">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>

    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        
        /* Install Banner Animation */
        .slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // Registro del Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registrado: ', reg.scope))
                    .catch(err => console.log('SW error: ', err));
            });
        }
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Scissors, Calendar, User, Home, Bell, Clock, ChevronRight, Star, LogOut, 
            CheckCircle, X, Phone, Trash2, RefreshCw, Shield, DollarSign, AlertCircle, 
            Smartphone, Zap, Search, Filter, Download 
        } from 'lucide-react';

        import { initializeApp } from "firebase/app";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, collection, addDoc, getDocs, query, deleteDoc, updateDoc, doc, onSnapshot, where } from "firebase/firestore";

        // --- FIREBASE CONFIGURATION ---
        // RECUERDA: Aquí debes poner tu config real de Firebase antes de subir a GitHub
        const firebaseConfig = {
            apiKey: "AIzaSyCDjmyuc0VSiHZIH_YqnMJnyDL-uktkMYw",
            authDomain: "barberia-yoel.firebaseapp.com",
            projectId: "barberia-yoel",
            storageBucket: "barberia-yoel.firebasestorage.app",
            messagingSenderId: "942416678010",
            appId: "1:942416678010:web:84017a43b59afe1679ffc3",
            measurementId: "G-6KJEGZC9DW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'barberia-yoel'; 

        // --- DATA ---
        const SERVICES = [
            { id: 'corte-clasico', category: 'Corte', title: 'Corte Clásico', price: 500, duration: '45 min', description: 'Corte tradicional.', icon: <Scissors className="w-6 h-6" /> },
            { id: 'corte-estilo', category: 'Corte', title: 'Fade / Degradado', price: 700, duration: '60 min', description: 'Degradado moderno.', icon: <Scissors className="w-6 h-6" /> },
            { id: 'barba-express', category: 'Barba', title: 'Perfilado de Barba', price: 300, duration: '30 min', description: 'Alineación con navaja.', icon: <User className="w-6 h-6" /> },
            { id: 'barba-completa', category: 'Barba', title: 'Ritual de Barba', price: 500, duration: '45 min', description: 'Corte y toalla caliente.', icon: <User className="w-6 h-6" /> },
            { id: 'black-mask', category: 'Tratamiento', title: 'Black Mask', price: 400, duration: '30 min', description: 'Limpieza profunda.', icon: <Star className="w-6 h-6" /> },
            { id: 'combo-yoel', category: 'VIP', title: 'Experiencia Yoel', price: 1500, duration: '120 min', description: 'Completo + Bebida.', icon: <Star className="w-6 h-6 text-amber-400" /> }
        ];
        const TIME_SLOTS = ["09:00 AM", "10:00 AM", "11:00 AM", "12:00 PM", "02:00 PM", "03:00 PM", "04:00 PM", "05:00 PM", "06:00 PM", "07:00 PM"];
        const ADMIN_EMAIL = "admin@yoel.com";

        // --- UTILS ---
        const parseTime = (t, d) => { if(!t||!d) return new Date(); const dt=new Date(d), [tm,m]=t.split(' '), [h,mn]=tm.split(':'); dt.setHours(h==='12'?0:parseInt(h)+(m==='PM'?12:0), mn, 0, 0); return dt; };
        const cleanPhone = p => p ? p.replace(/\D/g, '') : '';
        const formatPhone = p => { if(!p) return 'N/A'; const c=(''+p).replace(/\D/g,''), m=c.match(/^(\d{3})(\d{3})(\d{4})$/); return m ? `(${m[1]}) ${m[2]}-${m[3]}` : p; };
        const cleanPhoneForSearch = v => v ? v.toString().replace(/\D/g, '') : '';
        const normalizeText = t => t ? t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : '';

        // --- APP COMPONENT ---
        const App = () => {
            const [firebaseUser, setFirebaseUser] = useState(null);
            const [mockUser, setMockUser] = useState(null);
            const [view, setView] = useState('home');
            const [notifications, setNotifications] = useState([]);
            const [deferredPrompt, setDeferredPrompt] = useState(null);

            // Booking State
            const [selectedService, setSelectedService] = useState(null);
            const [selectedDate, setSelectedDate] = useState('');
            const [selectedTime, setSelectedTime] = useState('');
            const [editingAppId, setEditingAppId] = useState(null);
            const [originalData, setOriginalData] = useState(null);
            
            // Data
            const [allApps, setAllApps] = useState([]);
            const [loading, setLoading] = useState(true);
            const [toast, setToast] = useState(null);
            const [showSuccess, setShowSuccess] = useState(false);
            const [lastBooked, setLastBooked] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            // PWA Install Prompt Listener
            useEffect(() => {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                });
            }, []);

            const handleInstallClick = async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') setDeferredPrompt(null);
            };

            // Init Auth & Data
            useEffect(() => {
                const init = async () => { if(!auth.currentUser) await signInAnonymously(auth); };
                init();
                return onAuthStateChanged(auth, u => { 
                    setFirebaseUser(u); setLoading(false); 
                    if (u) {
                        onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'appointments')), s => {
                            setAllApps(s.docs.map(d => ({id: d.id, ...d.data()})));
                        });
                    }
                });
            }, []);

            // Notifications Logic
            useEffect(() => {
                if(!mockUser?.isAdmin) return;
                const interval = setInterval(() => {
                    const now = new Date();
                    allApps.forEach(a => {
                        if(a.status === 'cancelada') return;
                        const diff = Math.floor((parseTime(a.time, a.date) - now)/60000);
                        if(diff === 15) {
                            const msg = `Cita con ${a.userName} en 15 min.`;
                            setNotifications(p => p.some(x => x.appId === a.id) ? p : [{id: Date.now(), appId: a.id, title: 'Recordatorio', message: msg, read: false, time: 'Ahora'}, ...p]);
                            if(Notification.permission === 'granted') new Notification("Barbería Yoel", {body: msg});
                        }
                    });
                }, 60000);
                return () => clearInterval(interval);
            }, [allApps, mockUser]);

            // Memos
            const takenTimes = useMemo(() => selectedDate ? allApps.filter(a => a.date === selectedDate && a.status !== 'cancelada' && a.id !== editingAppId).map(a => a.time) : [], [selectedDate, allApps, editingAppId]);
            const isDayFull = takenTimes.length >= TIME_SLOTS.length;
            
            const clientApps = useMemo(() => (!firebaseUser || !mockUser) ? [] : allApps.filter(a => mockUser.isGuest ? a.userPhone === mockUser.phone : a.userId === firebaseUser.uid).sort((a,b) => parseTime(a.time, a.date) - parseTime(b.time, b.date)), [allApps, firebaseUser, mockUser]);
            
            const adminApps = useMemo(() => {
                let res = [...allApps];
                if(searchTerm.trim()) {
                    const cleanS = cleanPhoneForSearch(searchTerm);
                    const textS = normalizeText(searchTerm);
                    res = res.filter(a => (cleanS && cleanPhoneForSearch(a.userPhone).includes(cleanS)) || normalizeText(a.userName).includes(textS) || normalizeText(a.userEmail).includes(textS));
                }
                return res.sort((a,b) => parseTime(a.time, a.date) - parseTime(b.time, b.date));
            }, [allApps, searchTerm]);

            // Actions
            const showToast = (msg, type='success') => { setToast({msg, type}); setTimeout(() => setToast(null), 3000); };
            
            const handleBook = async () => {
                if(!selectedDate || !selectedTime || !selectedService) return;
                try {
                    let u = { uid: firebaseUser.uid, name: mockUser.displayName, email: mockUser.email, phone: mockUser.phone, isGuest: !!mockUser.isGuest };
                    if(mockUser.isAdmin && originalData) u = { uid: originalData.userId, name: originalData.userName, email: originalData.userEmail, phone: originalData.userPhone, isGuest: originalData.isGuestBooking };
                    
                    const data = { serviceId: selectedService.id, serviceTitle: selectedService.title, price: selectedService.price, date: selectedDate, time: selectedTime, updatedAt: new Date().toISOString(), status: 'confirmada', userId: u.uid, userName: u.name, userEmail: u.email, userPhone: cleanPhone(u.phone), isGuestBooking: u.isGuest };
                    
                    if(editingAppId) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'appointments', editingAppId), data);
                        showToast('Cita actualizada'); setView(mockUser.isAdmin ? 'admin' : 'appointments');
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'appointments'), {...data, createdAt: new Date().toISOString()});
                        setLastBooked(data); setShowSuccess(true);
                    }
                    setEditingAppId(null); setOriginalData(null); setSelectedService(null); setSelectedDate(''); setSelectedTime('');
                } catch { showToast("Error al procesar", 'error'); }
            };

            const handleCancel = async (e, id) => { e.stopPropagation(); if(confirm("¿Cancelar cita?")) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'appointments', id)); showToast('Eliminada'); } };
            const handleStartReschedule = (app) => { setEditingAppId(app.id); setOriginalData(app); setSelectedService(SERVICES.find(s => s.id === app.serviceId) || SERVICES[0]); setSelectedDate(app.date); setSelectedTime(app.time); setView('book'); };

            // Sub-Components (Simplified for brevity)
            const NavItem = ({i:Icon, l, id}) => <button onClick={()=>setView(id)} className={`flex flex-col items-center ${view===id ? 'text-amber-500' : 'text-slate-500'}`}><Icon size={24} strokeWidth={view===id?2.5:2}/><span className="text-[10px] font-bold">{l}</span></button>;
            
            // Views
            if(loading) return <div className="h-screen bg-slate-900 flex items-center justify-center text-amber-500 font-bold">CARGANDO...</div>;
            
            // Login Screen (Inline)
            if(!mockUser) {
                return (
                    <div className="min-h-screen bg-slate-900 flex flex-col justify-center p-6 text-slate-100">
                        <div className="mb-6 text-center animate-fade-in"><div className="w-20 h-20 bg-amber-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg"><Scissors className="w-10 h-10 text-slate-900"/></div><h1 className="text-4xl font-bold text-amber-500">YOEL</h1><p className="text-slate-400 text-sm">Barber Studio</p></div>
                        <div className="bg-slate-800 rounded-2xl p-8 shadow-xl border border-slate-700">
                            {/* Basic Auth Form Logic inside App component for single file simplicity */}
                            <LoginForm onLogin={u => { setMockUser(u); setView(u.isAdmin ? 'admin' : 'home'); }} db={db} appId={appId} />
                        </div>
                        {/* Install PWA Button for Login Screen */}
                        {deferredPrompt && (
                            <button onClick={handleInstallClick} className="mt-8 mx-auto flex items-center gap-2 bg-slate-800 text-amber-500 px-6 py-3 rounded-full border border-amber-500/30 shadow-lg animate-bounce-in">
                                <Download size={20} /> <span className="font-bold text-sm">INSTALAR APP</span>
                            </button>
                        )}
                    </div>
                );
            }

            // Logged In App
            return (
                <div className="min-h-screen bg-slate-900 font-sans text-white pb-safe relative">
                    <header className="fixed top-0 w-full bg-slate-900/95 backdrop-blur z-40 px-6 h-16 flex justify-between items-center border-b border-slate-800">
                        <div className="flex items-center gap-2"><Scissors className="text-amber-500"/><span className="font-bold text-xl">YOEL</span></div>
                        {!mockUser.isAdmin && <button onClick={()=>setView('notifications')} className="relative p-2"><Bell className="text-slate-300"/>{notifications.filter(n=>!n.read).length>0 && <span className="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full"/>}</button>}
                    </header>

                    <main className="pt-20 pb-24 px-4">
                        {/* Install PWA Banner (Logged In) */}
                        {deferredPrompt && (
                            <div className="bg-gradient-to-r from-amber-500 to-orange-600 text-slate-900 p-4 rounded-xl mb-6 flex justify-between items-center shadow-lg slide-up">
                                <div><p className="font-bold text-sm">¡Instala la App!</p><p className="text-xs opacity-80">Reserva más rápido desde tu inicio.</p></div>
                                <button onClick={handleInstallClick} className="bg-slate-900 text-white text-xs font-bold px-3 py-2 rounded-lg">INSTALAR</button>
                            </div>
                        )}

                        {mockUser.isAdmin ? (
                            // Admin View
                            view === 'book' ? <BookingView /> : 
                            view === 'notifications' ? <ClientAppsView /> :
                            <AdminDashboard />
                        ) : (
                            // Client View
                            view === 'home' ? <HomeView /> :
                            view === 'book' ? <BookingView /> :
                            view === 'appointments' ? <ClientAppsView /> :
                            view === 'profile' ? <ProfileView /> : null
                        )}
                    </main>

                    <nav className="fixed bottom-0 w-full bg-slate-800/95 backdrop-blur border-t border-slate-700 pb-safe px-6 h-20 flex justify-between items-center z-50">
                        {mockUser.isAdmin ? (
                           <div className="w-full flex justify-around"><NavItem i={User} l="Admin" id="admin"/><button onClick={()=>setMockUser(null)} className="text-red-400 flex flex-col items-center"><LogOut size={24}/><span className="text-[10px] font-bold">Salir</span></button></div>
                        ) : (
                           <><NavItem i={Home} l="Inicio" id="home"/><NavItem i={Calendar} l="Agendar" id="book"/><NavItem i={Clock} l="Citas" id="appointments"/><NavItem i={User} l="Perfil" id="profile"/></>
                        )}
                    </nav>
                    
                    {/* Modals */}
                    {showSuccess && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/95 animate-fade-in">
                            <div className="bg-slate-800 p-8 rounded-3xl shadow-2xl border border-slate-700 max-w-sm w-full text-center mx-4">
                                <div className="w-20 h-20 mx-auto mb-4"><CheckCircle className="w-full h-full text-green-500"/></div>
                                <h2 className="text-2xl font-bold mb-2">¡Listo!</h2><p className="text-slate-400 mb-6">Cita agendada.</p>
                                {lastBooked && <div className="bg-slate-900 p-4 rounded-xl text-left mb-6"><p className="text-amber-500 text-xs font-bold uppercase">Resumen</p><p className="font-bold">{lastBooked.serviceTitle}</p><div className="flex justify-between text-sm text-slate-400 mt-1"><span>{lastBooked.date}</span><span>{lastBooked.time}</span></div></div>}
                                <button onClick={()=>{setShowSuccess(false); setView('appointments');}} className="w-full bg-amber-500 text-slate-900 font-bold py-3 rounded-xl">ENTENDIDO</button>
                            </div>
                        </div>
                    )}
                    {toast && <div className="fixed top-4 left-1/2 -translate-x-1/2 z-[100] bg-green-500 text-white px-6 py-3 rounded-full shadow-xl font-bold text-sm animate-bounce-in">{toast.msg}</div>}
                </div>
            );

            // --- Sub-Views (Defined inside to access state closures cleanly) ---
            function HomeView() {
                return (
                    <div className="animate-fade-in">
                        <div className="relative h-64 bg-slate-800 rounded-3xl mb-6 overflow-hidden shadow-2xl group">
                            <div className="absolute inset-0 bg-gradient-to-t from-slate-900/90 to-transparent z-10"/>
                             <img src="https://images.unsplash.com/photo-1585747860715-2ba37e788b70?auto=format&fit=crop&w=800" className="w-full h-full object-cover opacity-60 group-hover:scale-105 transition-transform duration-700" />
                            <div className="absolute bottom-6 left-6 z-20">
                                <h2 className="text-amber-500 text-xs font-bold tracking-widest mb-1">BARBER STUDIO</h2>
                                <h1 className="text-3xl font-extrabold leading-none">ESTILO<br/>QUE DEFINE.</h1>
                                {mockUser?.isGuest && <span className="mt-2 inline-block bg-amber-500/20 text-amber-500 text-[10px] font-bold px-2 py-1 rounded border border-amber-500/30">INVITADO</span>}
                            </div>
                        </div>
                        <div className="flex gap-3 mb-8">
                            <button onClick={()=>setView('book')} className="flex-1 bg-amber-500 py-4 rounded-2xl text-slate-900 font-bold shadow-lg shadow-amber-500/20 active:scale-95 transition-transform flex flex-col items-center gap-1"><Calendar size={24}/><span className="text-xs">RESERVAR</span></button>
                            <button onClick={()=>setView('appointments')} className="flex-1 bg-slate-800 py-4 rounded-2xl border border-slate-700 active:scale-95 transition-transform flex flex-col items-center gap-1"><Clock size={24}/><span className="text-xs">MIS CITAS</span></button>
                        </div>
                        <h3 className="font-bold text-lg mb-4">Servicios Populares</h3>
                        <div className="space-y-3">
                            {SERVICES.slice(0,3).map(s => (
                                <div key={s.id} className="bg-slate-800 p-4 rounded-xl flex items-center gap-4 border border-slate-700">
                                    <div className="bg-slate-700/50 p-3 rounded-xl text-amber-500">{s.icon}</div>
                                    <div className="flex-1"><h4 className="font-bold">{s.title}</h4><p className="text-slate-400 text-xs">RD$ {s.price}</p></div>
                                    <button onClick={()=>{setSelectedService(s); setView('book')}} className="bg-slate-700 p-2 rounded-lg hover:bg-amber-500 hover:text-slate-900 transition-colors"><ChevronRight size={20}/></button>
                                </div>
                            ))}
                        </div>
                    </div>
                )
            }

            function BookingView() {
                return (
                    <div className="animate-fade-in pt-4">
                         <div className="flex justify-between items-center mb-6">
                             <h2 className="text-2xl font-bold">{editingAppId ? 'Editar Cita' : 'Nueva Reserva'}</h2>
                             {editingAppId && <button onClick={()=>{setEditingAppId(null); setOriginalData(null); setSelectedService(null);}} className="text-xs text-red-400 underline">Cancelar</button>}
                         </div>
                         {!selectedService ? (
                             <div className="space-y-3">{SERVICES.map(s => <div key={s.id} onClick={()=>setSelectedService(s)} className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex gap-4 items-center active:bg-slate-700 transition-colors"><div className="text-amber-500 bg-slate-900 p-3 rounded-xl">{s.icon}</div><div><h3 className="font-bold">{s.title}</h3><p className="text-amber-500 font-bold text-sm">RD$ {s.price}</p></div></div>)}</div>
                         ) : (
                             <div className="animate-fade-in">
                                 <div className="bg-slate-800 p-4 rounded-xl border-l-4 border-amber-500 flex justify-between items-center mb-8"><div><p className="text-xs text-slate-400 uppercase">Servicio</p><h3 className="font-bold">{selectedService.title}</h3></div><button onClick={()=>setSelectedService(null)} className="p-2 bg-slate-700 rounded-full"><RefreshCw size={14}/></button></div>
                                 <label className="block text-sm font-bold mb-2 ml-1 text-slate-300">FECHA</label>
                                 <input type="date" min={new Date().toISOString().split('T')[0]} value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 mb-6 outline-none focus:border-amber-500 font-bold" />
                                 {selectedDate && (isDayFull ? <div className="bg-red-500/10 p-4 rounded-xl text-red-400 flex gap-3 items-center mb-6"><AlertCircle/><span className="font-bold text-sm">Día completo</span></div> : <div className="mb-8"><label className="block text-sm font-bold mb-2 ml-1 text-slate-300">HORA</label><div className="grid grid-cols-3 gap-2">{TIME_SLOTS.map(t => <button key={t} disabled={takenTimes.includes(t)} onClick={()=>setSelectedTime(t)} className={`py-3 rounded-lg text-xs font-bold border ${takenTimes.includes(t) ? 'bg-slate-800/50 text-slate-600 border-slate-800' : selectedTime === t ? 'bg-amber-500 text-slate-900 border-amber-500' : 'bg-slate-800 text-slate-400 border-slate-700'}`}>{t}</button>)}</div></div>)}
                                 <button disabled={!selectedDate || !selectedTime || isDayFull} onClick={handleBook} className="w-full bg-green-500 text-white font-bold py-4 rounded-xl disabled:bg-slate-800 disabled:text-slate-600 shadow-lg">CONFIRMAR</button>
                             </div>
                         )}
                    </div>
                )
            }

            function ClientAppsView() {
                return (
                    <div className="animate-fade-in pt-4">
                        <h2 className="text-2xl font-bold mb-6">Mis Reservas</h2>
                        {clientApps.length === 0 ? <div className="text-center py-20 opacity-50"><Calendar size={64} className="mx-auto mb-4"/><p>No tienes citas activas.</p></div> : 
                        <div className="space-y-4">{clientApps.map(a => (
                            <div key={a.id} className="bg-slate-800 p-5 rounded-2xl border border-slate-700 relative">
                                <div className="flex justify-between mb-2"><h3 className="font-bold text-lg">{a.serviceTitle}</h3><span className="bg-green-500/20 text-green-400 px-2 py-0.5 rounded text-[10px] font-bold uppercase">{a.status}</span></div>
                                <p className="text-amber-500 font-bold mb-4">RD$ {a.price}</p>
                                <div className="flex gap-4 text-sm text-slate-400 mb-4"><span>{a.date}</span><span>{a.time}</span></div>
                                <div className="flex gap-2"><button onClick={e=>handleCancel(e, a.id)} className="flex-1 bg-slate-900 py-2 rounded-lg text-xs font-bold text-red-400">CANCELAR</button><button onClick={()=>handleStartReschedule(a)} className="flex-1 bg-amber-500 py-2 rounded-lg text-xs font-bold text-slate-900">REAGENDAR</button></div>
                            </div>
                        ))}</div>}
                    </div>
                )
            }
            
            function AdminDashboard() {
                const filtered = adminApps.length;
                const total = allApps.length;
                const revenue = adminApps.reduce((acc, c) => acc + (c.price||0), 0);
                return (
                    <div className="animate-fade-in pt-4">
                        <div className="flex justify-between items-center mb-6"><div><h2 className="text-2xl font-bold">Admin Panel</h2><p className="text-xs text-slate-400">Bienvenido, Yoel</p></div><button onClick={()=>setView('notifications')} className="p-2 bg-slate-800 rounded-full border border-slate-700 relative"><Bell size={20}/>{notifications.filter(n=>!n.read).length>0&&<span className="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full"/>}</button></div>
                        <div className="relative mb-4"><Search className="absolute left-3 top-3.5 text-slate-500" size={18}/><input type="text" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 pl-10 outline-none focus:border-amber-500" placeholder="Buscar..." />{searchTerm && <button onClick={()=>setSearchTerm('')} className="absolute right-3 top-3.5 text-slate-500"><X size={18}/></button>}</div>
                        {searchTerm && <div className="flex justify-between text-xs text-slate-400 mb-6 bg-slate-800/50 p-2 rounded-lg border border-slate-700"><span>Viendo {filtered} de {total}</span><button onClick={()=>setSearchTerm('')} className="text-amber-500 underline">Ver todas</button></div>}
                        <div className="grid grid-cols-2 gap-4 mb-8">
                            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700"><div className="flex items-center gap-2 text-slate-400 mb-2"><Calendar size={16}/><span className="text-xs font-bold">Citas</span></div><p className="text-2xl font-bold">{filtered}</p></div>
                            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700"><div className="flex items-center gap-2 text-slate-400 mb-2"><DollarSign size={16}/><span className="text-xs font-bold">Ingresos</span></div><p className="text-2xl font-bold text-amber-500">RD$ {revenue.toLocaleString()}</p></div>
                        </div>
                        <h3 className="font-bold mb-4 flex items-center gap-2"><Clock size={18} className="text-amber-500"/> Agenda</h3>
                        <div className="space-y-3">{adminApps.map(a => (
                            <div key={a.id} className="bg-slate-800 p-4 rounded-xl border-l-4 border-amber-500 relative">
                                <div className="flex justify-between items-start">
                                    <div><h4 className="font-bold">{a.userName} {a.isGuestBooking && <span className="text-[10px] bg-slate-700 px-1 rounded ml-1 text-slate-300">INVITADO</span>}</h4><p className="text-xs text-slate-400 font-mono mt-0.5">{formatPhone(a.userPhone)}</p><div className="mt-2 text-sm font-medium text-amber-500">{a.serviceTitle}</div></div>
                                    <div className="text-right"><p className="font-bold text-lg">{a.time}</p><p className="text-xs text-slate-500">{a.date}</p></div>
                                </div>
                                <div className="mt-3 pt-3 border-t border-slate-700/50 flex justify-end gap-3"><button onClick={()=>handleStartReschedule(a)} className="px-3 py-1.5 bg-blue-500/10 text-blue-400 rounded-lg text-xs font-bold flex items-center gap-1"><RefreshCw size={12}/> EDITAR</button><button onClick={e=>handleCancel(e, a.id)} className="px-3 py-1.5 bg-red-500/10 text-red-400 rounded-lg text-xs font-bold flex items-center gap-1"><Trash2 size={12}/> BORRAR</button></div>
                            </div>
                        ))}
                        {adminApps.length===0 && <div className="text-center py-10 opacity-50"><Filter className="mx-auto mb-2"/><p>No hay resultados.</p></div>}
                        </div>
                    </div>
                )
            }
            
            function ProfileView() {
                return (
                    <div className="animate-fade-in pt-4">
                         <div className="bg-slate-800 rounded-2xl p-6 text-center border border-slate-700 mb-6"><div className="w-24 h-24 bg-slate-900 rounded-full mx-auto mb-4 flex items-center justify-center border-2 border-amber-500"><User className="w-10 h-10 text-amber-500"/></div><h2 className="text-2xl font-bold">{mockUser.displayName}</h2><p className="text-sm text-slate-500">{mockUser.email || mockUser.phone}</p>{mockUser.isGuest && <span className="inline-block mt-2 bg-amber-500 text-slate-900 text-xs font-bold px-2 py-1 rounded">INVITADO</span>}</div>
                         <button onClick={()=>{setMockUser(null); setView('home'); setSelectedService(null);}} className="w-full border border-red-500/30 text-red-400 py-4 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-red-500/10"><LogOut size={18}/> Cerrar Sesión</button>
                    </div>
                )
            }
        };

        // --- AUTH FORM (Extracted for clarity) ---
        const LoginForm = ({ onLogin, db, appId }) => {
            const [m, sM] = useState('login');
            const [gl, sGl] = useState(false);
            const [n, sN] = useState(''); const [p, sP] = useState(''); const [e, sE] = useState(''); const [pw, sPw] = useState(''); const [err, sErr] = useState(''); const [ld, sLd] = useState(false);

            const sub = async (ev) => {
                ev.preventDefault(); sErr(''); sLd(true);
                // Guest Lookup
                if(m==='guest' && gl) {
                    const cp = cleanPhoneForSearch(p);
                    if(cp.length<10) { sErr('Teléfono inválido'); sLd(false); return; }
                    try {
                        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'appointments'), where('userPhone', '==', cp));
                        const sn = await getDocs(q);
                        if(!sn.empty) { onLogin({displayName: sn.docs[0].data().userName||'Invitado', phone: cp, email:'', isAdmin:false, isGuest:true}); }
                        else { sErr('No encontramos citas.'); }
                    } catch { sErr('Error de red.'); }
                    sLd(false); return;
                }
                // Regular Auth
                setTimeout(() => {
                   if(m==='guest' && !gl && (!n.trim() || cleanPhoneForSearch(p).length<10)) { sErr('Datos incompletos'); sLd(false); return; }
                   if(m!=='guest' && (!e.includes('@') || pw.length<6)) { sErr('Datos incorrectos'); sLd(false); return; }
                   onLogin({ displayName: n||e.split('@')[0]||'Invitado', email: m==='guest'?'':e, phone: m==='guest'?cleanPhoneForSearch(p):'', isAdmin: e===ADMIN_EMAIL, isGuest: m==='guest' });
                   sLd(false);
                }, 800);
            };

            return (
                <>
                    <div className="flex border-b border-slate-700 mb-6">
                        {['login','register','guest'].map(x=><button key={x} onClick={()=>{sM(x); sGl(false); sErr('');}} className={`flex-1 py-2 text-xs font-bold uppercase ${m===x?'text-amber-500 border-b-2 border-amber-500':'text-slate-500'}`}>{x==='guest'?'Invitado':x}</button>)}
                    </div>
                    <h2 className="text-center font-bold mb-4 text-lg">{m==='guest'?(gl?'Buscar Cita':'Agenda Rápida'):(m==='register'?'Crear Cuenta':'Bienvenido')}</h2>
                    <form onSubmit={sub} className="space-y-4">
                        {(m==='register' || (m==='guest' && !gl)) && <div className="relative"><User size={18} className="absolute left-3 top-3 text-slate-500"/><input value={n} onChange={e=>sN(e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 pl-10 outline-none focus:border-amber-500" placeholder="Nombre" required/></div>}
                        {m==='guest' && <div className="relative"><Smartphone size={18} className="absolute left-3 top-3 text-slate-500"/><input type="tel" value={p} onChange={e=>sP(e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 pl-10 outline-none focus:border-amber-500" placeholder="Teléfono (809...)" required/></div>}
                        {m!=='guest' && <><input value={e} onChange={ev=>sE(ev.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 outline-none focus:border-amber-500" placeholder="Correo" required/><input type="password" value={pw} onChange={ev=>sPw(ev.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 outline-none focus:border-amber-500" placeholder="Contraseña" required/></>}
                        {err && <div className="text-red-400 text-xs text-center">{err}</div>}
                        <button disabled={ld} className="w-full bg-amber-500 text-slate-900 font-bold py-2 rounded-lg">{ld?'Procesando...':'CONTINUAR'}</button>
                    </form>
                    {m==='guest' && <div className="mt-4 text-center"><button onClick={()=>{sGl(!gl); sErr('');}} className="text-xs text-amber-500 underline">{gl?'← Agendar nueva':'¿Ya tienes cita? Buscar'}</button></div>}
                    {m==='login' && <div className="mt-6 pt-4 border-t border-slate-700 text-center"><button onClick={()=>{sE(ADMIN_EMAIL); sPw('admin123'); sM('login');}} className="text-xs text-slate-500 flex items-center justify-center gap-1 mx-auto hover:text-amber-500"><Shield size={12}/> Acceso Admin</button></div>}
                </>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
